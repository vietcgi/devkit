---
# Git Configuration Role
# Manages git configuration, hooks, templates, and reload mechanisms
# Supports system-wide and user-specific configurations

- name: Initialize git variables
  ansible.builtin.set_fact:
    git_config_home: "{{ git_home_dir }}/.config/git"
    git_templates_dir: "{{ git_home_dir }}/.git-templates"
    git_hooks_dir: "{{ git_home_dir }}/.git-templates/hooks"
    git_global_config: "{{ git_home_dir }}/.gitconfig"
    git_local_config: "{{ git_home_dir }}/.gitconfig.local"
    git_attributes_file: "{{ git_home_dir }}/.gitattributes"
  tags: [always, git]

- name: Create git directories
  tags: [git, setup]
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  loop:
    - "{{ git_config_home }}"
    - "{{ git_templates_dir }}"
    - "{{ git_hooks_dir }}"
    - "{{ git_home_dir }}/.devkit/git"

- name: Deploy global gitconfig (user info, core settings)
  ansible.builtin.template:
    src: gitconfig.j2
    dest: "{{ git_global_config }}"
    mode: '0644'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  changed_when: false
  notify: reload git config
  tags: [git, config]

- name: Deploy gitconfig.local (local overrides, credentials)
  ansible.builtin.template:
    src: gitconfig.local.j2
    dest: "{{ git_local_config }}"
    mode: '0644'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  changed_when: false
  notify: reload git config
  tags: [git, config]

- name: Deploy global gitattributes
  ansible.builtin.template:
    src: gitattributes.j2
    dest: "{{ git_attributes_file }}"
    mode: '0644'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  tags: [git, config]

- name: Deploy gitignore_global
  ansible.builtin.copy:
    src: gitignore_global
    dest: "{{ git_config_home }}/ignore"
    mode: '0644'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  tags: [git, config]

# Git Hooks Setup
# NOTE: Custom hooks disabled when pre-commit framework is enabled
# Pre-commit handles all hooks via .pre-commit-config.yaml
# If needed to create custom hooks, set git_enable_precommit: false
- name: Create pre-commit hook
  ansible.builtin.template:
    src: hooks/pre-commit.sh.j2
    dest: "{{ git_hooks_dir }}/pre-commit"
    mode: '0755'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  notify: reload git hooks
  when: not git_enable_precommit | default(true)
  tags: [git, hooks]

- name: Create commit-msg hook
  ansible.builtin.template:
    src: hooks/commit-msg.sh.j2
    dest: "{{ git_hooks_dir }}/commit-msg"
    mode: '0755'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  notify: reload git hooks
  when: not git_enable_precommit | default(true)
  tags: [git, hooks]

- name: Create post-commit hook
  ansible.builtin.template:
    src: hooks/post-commit.sh.j2
    dest: "{{ git_hooks_dir }}/post-commit"
    mode: '0755'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  when: not git_enable_precommit | default(true)
  tags: [git, hooks]

- name: Create prepare-commit-msg hook
  ansible.builtin.template:
    src: hooks/prepare-commit-msg.sh.j2
    dest: "{{ git_hooks_dir }}/prepare-commit-msg"
    mode: '0755'
    owner: "{{ git_current_user }}"
    group: "{{ ansible_user_gid | default(omit) }}"
  when: not git_enable_precommit | default(true)
  tags: [git, hooks]

# Git Ignore Configuration
- name: Configure global gitignore
  community.general.git_config:
    name: core.excludesFile
    value: "{{ git_config_home }}/ignore"
    scope: global
  changed_when: false
  notify: reload git config
  tags: [git, config]

# Git Templates Configuration
- name: Configure git to use templates directory
  community.general.git_config:
    name: init.templateDir
    value: "{{ git_templates_dir }}"
    scope: global
  changed_when: false
  notify: reload git config
  tags: [git, config]

- name: Configure git to use hooks from templates
  community.general.git_config:
    name: core.hooksPath
    value: "{{ git_hooks_dir }}"
    scope: global
  when: not git_enable_precommit | default(true)
  changed_when: false
  notify: reload git config
  tags: [git, config]

# GitHub SSH URL Rewrite (LOCAL ONLY - devkit repo only, NOT global)
# IMPORTANT: Global SSH rewrite breaks Homebrew and other tools
# Only apply SSH rewrite to devkit repository
- name: Check if SSH keys exist for git operations
  ansible.builtin.stat:
    path: "{{ item }}"
  register: git_ssh_key_stat
  loop:
    - "{{ git_home_dir }}/.ssh/id_rsa"
    - "{{ git_home_dir }}/.ssh/id_ed25519"
    - "{{ git_home_dir }}/.ssh/id_ecdsa"
  tags: [git, config, ssh]

- name: Configure git to use SSH for GitHub URLs in devkit repo (if SSH keys available)
  ansible.builtin.shell: |
    set -o pipefail
    cd {{ git_repo_root }}
    git config --local url."git@github.com:".insteadOf https://github.com/
  when:
    - git_repo_root is defined
    - git_ssh_key_stat.results | selectattr('stat.exists', 'equalto', true) | list | length > 0
  changed_when: false
  notify: reload git config
  tags: [git, config, ssh]

- name: Remove SSH URL rewrite if no SSH keys found (prevent auth failures)
  ansible.builtin.shell: |
    cd {{ git_repo_root }}
    git config --local --unset url."git@github.com:".insteadOf 2>/dev/null || true
  when:
    - git_repo_root is defined
    - git_ssh_key_stat.results | selectattr('stat.exists', 'equalto', true) | list | length == 0
  changed_when: false
  notify: reload git config
  tags: [git, config, ssh]

# User Configuration
- name: Configure git user info from variables
  community.general.git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - name: user.name
      value: "{{ git_user_name | default('') }}"
    - name: user.email
      value: "{{ git_user_email | default('') }}"
  when: item.value | length > 0
  changed_when: false
  notify: reload git config
  tags: [git, config, user]

# Conditional GPG Configuration
- name: Configure git GPG signing (optional)
  tags: [git, gpg, optional]
  block:
    - name: Check GPG key availability
      ansible.builtin.shell: |
        set -o pipefail
        gpg --list-secret-keys --with-colons | grep -q "{{ git_gpg_key_id }}"
      register: git_gpg_key_check
      changed_when: false
      failed_when: false
      when: git_enable_gpg_signing | default(false)
      tags: [git, gpg]

    - name: Configure git GPG signing
      community.general.git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: global
      loop:
        - name: user.signingKey
          value: "{{ git_gpg_key_id }}"
        - name: commit.gpgSign
          value: "{{ git_auto_sign_commits | default('false') }}"
      when: git_enable_gpg_signing | default(false) and git_gpg_key_check is defined and git_gpg_key_check.rc == 0
      changed_when: false
      notify: reload git config
      tags: [git, gpg]

# SSH Key Configuration (optional)
- name: Configure SSH signing (optional)
  tags: [git, ssh, optional]
  block:
    - name: Check SSH key availability
      ansible.builtin.stat:
        path: "{{ git_ssh_signing_key }}"
      register: git_ssh_key_check
      when: git_enable_ssh_signing | default(false)
      tags: [git, ssh]

    - name: Configure git SSH signing
      community.general.git_config:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        scope: global
      loop:
        - name: gpg.format
          value: "ssh"
        - name: user.signingKey
          value: "{{ git_ssh_signing_key }}"
        - name: commit.gpgSign
          value: "{{ git_auto_sign_commits | default('false') }}"
      when:
        - git_enable_ssh_signing | default(false)
        - git_ssh_key_check is defined
        - git_ssh_key_check.stat.exists
      changed_when: false
      notify: reload git config
      tags: [git, ssh]

# Pre-Commit Framework Setup (Multi-language quality enforcement)
- name: Install pre-commit framework
  tags: [git, precommit, optional]
  block:
    - name: Check if pre-commit is already installed
      ansible.builtin.command: which pre-commit
      environment:
        PATH: "{{ git_home_dir }}/.local/bin:{{ homebrew_prefix | default('/usr/local') }}/bin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin:{{ ansible_env.PATH }}" # yamllint disable-line rule:line-length
      register: git_precommit_check
      failed_when: false
      changed_when: false
      when: git_enable_precommit | default(true)
      tags: [git, precommit, install, verify]

    - name: Install pre-commit via pipx (if not already installed)
      ansible.builtin.command: pipx install pre-commit
      environment:
        PATH: "{{ git_home_dir }}/.local/bin:{{ homebrew_prefix | default('/usr/local') }}/bin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin:{{ ansible_env.PATH }}" # yamllint disable-line rule:line-length
        HOME: "{{ git_home_dir }}"
      register: git_precommit_install
      when:
        - git_enable_precommit | default(true)
        - git_precommit_check.rc != 0
      changed_when: "'installed' in git_precommit_install.stdout or 'Installed' in git_precommit_install.stdout"
      tags: [git, precommit, install]

    - name: Verify pre-commit installation
      ansible.builtin.command: pre-commit --version
      environment:
        PATH: "{{ git_home_dir }}/.local/bin:{{ homebrew_prefix | default('/usr/local') }}/bin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin:{{ ansible_env.PATH }}" # yamllint disable-line rule:line-length
        HOME: "{{ git_home_dir }}"
      register: git_precommit_version
      changed_when: false
      when: git_enable_precommit | default(true)
      tags: [git, precommit, verify]

    - name: Copy .pre-commit-config.yaml to repo root
      ansible.builtin.copy:
        src: >-
          {{ role_path }}/../../../.pre-commit-config.yaml
        dest: "{{ git_repo_root }}/.pre-commit-config.yaml"
        mode: '0644'
        owner: "{{ git_current_user }}"
        group: "{{ ansible_user_gid | default(omit) }}"
      when:
        - git_enable_precommit | default(true)
        - git_repo_root is defined
      tags: [git, precommit, config]

    - name: Unset core.hooksPath if set (pre-commit requirement)
      ansible.builtin.shell: |
        set -o pipefail
        if git config --global core.hooksPath > /dev/null 2>&1; then
          git config --global --unset core.hooksPath
          echo "unset"
        else
          echo "not-set"
        fi
      register: git_hooks_path_status
      changed_when: false
      when: git_enable_precommit | default(true)
      tags: [git, precommit, config]

    - name: Initialize pre-commit hooks in repository
      ansible.builtin.shell: |
        cd {{ git_repo_root | default(lookup('env', 'PWD')) }}
        pre-commit install
      environment:
        PATH: "{{ git_home_dir }}/.local/bin:{{ homebrew_prefix | default('/usr/local') }}/bin:/usr/local/bin:/usr/bin:/bin:/sbin:/usr/sbin:{{ ansible_env.PATH }}" # yamllint disable-line rule:line-length
        HOME: "{{ git_home_dir }}"
      register: git_precommit_init
      changed_when: false
      when: git_enable_precommit | default(true)
      tags: [git, precommit, init]

    - name: Display pre-commit installation status
      ansible.builtin.debug:
        msg: |
          Pre-Commit Framework Status:
          =============================
          Installed: {{ git_precommit_version.stdout | default('N/A') }}
          Hooks Configured:
            {{ git_precommit_init.stdout_lines | default(['Not initialized']) }}
      when: git_enable_precommit | default(true)
      tags: [git, precommit, verify]

# Git Aliases
- name: Configure git aliases
  community.general.git_config:
    name: "alias.{{ item.key }}"
    value: "{{ item.value }}"
    scope: global
  loop: "{{ git_aliases | dict2items }}"
  when: git_aliases is defined and git_aliases | length > 0
  changed_when: false
  tags: [git, config, aliases]

# Git Display/Formatting Configuration
- name: Configure git display settings
  community.general.git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - name: color.ui
      value: "true"
    - name: log.date
      value: "{{ git_log_date_format | default('iso') }}"
    - name: log.showSignature
      value: "{{ git_show_signature | default('false') }}"
  changed_when: false
  tags: [git, config, display]

# Merge/Rebase Configuration
- name: Configure merge and rebase settings
  community.general.git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - name: pull.rebase
      value: "{{ git_pull_rebase | default('true') }}"
    - name: rebase.autoStash
      value: "{{ git_rebase_auto_stash | default('true') }}"
    - name: merge.conflictStyle
      value: "{{ git_merge_conflict_style | default('diff3') }}"
  changed_when: false
  tags: [git, config, merge]

# Performance Configuration
- name: Configure git performance settings
  community.general.git_config:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    scope: global
  loop:
    - name: core.preloadindex
      value: "true"
    - name: core.fsmonitor
      value: "{{ git_fsmonitor | default('true') }}"
    - name: feature.worktreeConfig
      value: "true"
  changed_when: false
  tags: [git, config, performance]

# Backup existing config
- name: Create backup of git config
  ansible.builtin.shell: |
    if [ -f "{{ git_global_config }}" ]; then
      cp "{{ git_global_config }}" \
        "{{ git_home_dir }}/.devkit/git/gitconfig.backup.$(date +%s)"
    fi
  changed_when: false
  tags: [git, backup]

# Verification
- name: Verify git is properly configured
  tags: [git, verify]
  block:
    - name: Check git user configuration
      ansible.builtin.shell: |
        set -o pipefail
        git config --get user.name && git config --get user.email
      register: git_user_check
      changed_when: false
      tags: [git, verify]

    - name: Check git hooks are accessible
      ansible.builtin.stat:
        path: "{{ git_hooks_dir }}/pre-commit"
      register: git_hooks_check
      tags: [git, verify]

    - name: Display git configuration status
      ansible.builtin.debug:
        msg: |
          Git Configuration Status:
          ==========================
          Config Directory: {{ git_config_home }}
          Templates Dir: {{ git_templates_dir }}
          Hooks Dir: {{ git_hooks_dir }}
          User Name: {{ git_user_check.stdout_lines[0] | default('NOT SET') }}
          User Email: {{ git_user_check.stdout_lines[1] | default('NOT SET') }}
          Hooks Available: {{ git_hooks_check.stat.exists }}
      tags: [git, verify]

- name: Final git configuration verification  # noqa: command-instead-of-module
  ansible.builtin.shell: git config --list --show-origin
  register: git_config_list
  changed_when: false
  tags: [git, verify]
