name: Code Quality & Coverage

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # Python code quality
  python-quality:
    name: Python Code Quality
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies and quality tools
      run: |
        pip install --upgrade pip setuptools wheel
        pip install PyYAML requests
        pip install -e ".[dev]"

    - name: Check code formatting with black
      run: black --check cli/

    - name: Check import sorting with isort
      run: isort --check-only cli/

    - name: Lint with Ruff
      run: ruff check cli/

    - name: Lint with pylint
      run: >
        pylint cli/ --max-line-length=100

    - name: Run pytest with coverage
      run: |
        pytest tests/ \
          --cov=cli \
          --cov-report=xml \
          --cov-report=html \
          --cov-report=term-missing \
          --junitxml=junit.xml

    - name: Enforce coverage threshold (75%)
      run: |
        python -c "
        import xml.etree.ElementTree as ET
        tree = ET.parse('coverage.xml')
        root = tree.getroot()
        line_rate = float(root.get('line-rate', 0))
        coverage_pct = line_rate * 100
        print(f'Code Coverage: {coverage_pct:.2f}%')
        if coverage_pct < 75:
            print(f'ERROR: Coverage {coverage_pct:.2f}% is below 75% threshold')
            exit(1)
        else:
            print(f'Coverage meets threshold ({coverage_pct:.2f}% >= 75%)')
            exit(0)
        "

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        files: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: python-test-results
        path: |
          junit.xml
          htmlcov/
        if-no-files-found: ignore

  # Bash script quality
  bash-quality:
    name: Bash Script Quality
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install shellcheck and shfmt
      run: |
        sudo apt-get update
        sudo apt-get install -y shellcheck shfmt

    - name: Run shellcheck with strict options
      run: |
        shellcheck \
          --severity=warning \
          --format=gcc \
          bootstrap.sh \
          verify-setup.sh \
          update.sh \
          cli/config.sh

    - name: Run shfmt (shell formatting check)
      run: |
        shfmt -d bootstrap.sh verify-setup.sh \
          update.sh cli/config.sh

  # YAML quality
  yaml-quality:
    name: YAML Quality
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install yamllint
      run: pip install yamllint

    - name: Lint YAML files
      run: |
        yamllint -c .yamllint \
          setup.yml \
          inventory.yml \
          .github/workflows/*.yml \
          ansible/roles/*/

  # Complexity analysis
  complexity:
    name: Code Complexity Analysis
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install radon
      run: pip install radon

    - name: Cyclomatic complexity check
      run: |
        radon cc cli/ -a -s

    - name: Maintainability index
      run: |
        radon mi cli/ -s

  # Performance benchmarks
  performance:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install pytest-benchmark
      run: pip install pytest-benchmark

    - name: Run performance tests
      run: |
        pytest tests/ -v --benchmark-only 2>&1 | tee performance.log || true

  # Mutation Testing
  mutation-testing:
    name: Mutation Testing (Test Quality)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install dependencies
      run: |
        pip install -e .
        pip install pytest pytest-cov

    - name: Run mutation testing
      run: |
        python -m cli.mutation_test

    - name: Check mutation score
      run: |
        python -c "
        import json
        with open('.mutation_test/report.json') as f:
            report = json.load(f)
        score = report['mutation_score']
        print(f'Mutation Score: {score}%')
        if score < 70:
            print('Mutation score below 70% threshold')
            exit(1)
        elif score < 80:
            print('Mutation score below 80% (target)')
            exit(0)
        else:
            print('Mutation score meets target (80%+)')
            exit(0)
        "

    - name: Upload mutation report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: mutation-test-report
        path: .mutation_test/

  # Type Checking with mypy
  type-checking:
    name: Type Checking (mypy)
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: Install mypy and dependencies
      run: |
        pip install mypy click types-PyYAML types-requests types-setuptools

    - name: Run mypy type checking (strict mode)
      run: |
        mypy cli/ \
          --strict \
          --no-implicit-optional \
          --disallow-untyped-calls \
          --disallow-untyped-defs \
          --warn-redundant-casts \
          --warn-unused-ignores \
          --warn-return-any \
          --warn-unused-configs \
          --pretty \
          --show-error-context

  # Quality Summary
  quality-summary:
    name: Quality Summary
    needs: [python-quality, bash-quality, yaml-quality, complexity, performance, mutation-testing, type-checking]
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Print quality report
      run: |
        echo "════════════════════════════════════════════════════"
        echo "Code Quality Report"
        echo "════════════════════════════════════════════════════"
        echo "Python Quality:    ${{ needs.python-quality.result }}"
        echo "Bash Quality:      ${{ needs.bash-quality.result }}"
        echo "YAML Quality:      ${{ needs.yaml-quality.result }}"
        echo "Complexity:        ${{ needs.complexity.result }}"
        echo "Performance:       ${{ needs.performance.result }}"
        echo "Mutation Testing:  ${{ needs.mutation-testing.result }}"
        echo "Type Checking:     ${{ needs.type-checking.result }}"
        echo "════════════════════════════════════════════════════"
